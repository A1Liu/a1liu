#!/bin/sh

. "$(dirname "$0")/utils"
INSTALL_DIR="$(dirname "$(realpath "$0")")"
CFG_DIR="$(dirname "$INSTALL_DIR")"
LOCAL_DIR="${CFG_DIR}/local"
MOVE_DIR="${LOCAL_DIR}/preconf"

if [ "$DEBUG" = "true" ]; then
  echo "Config directory is:         $CFG_DIR"
  echo "Installation directory is:   $INSTALL_DIR"
  echo "Machine-local directory is:  $LOCAL_DIR"
  echo "Preconfig directory is:      $MOVE_DIR"
fi

mkdir -p $MOVE_DIR

# Template for machine-local shell endpoints
PRINT_TEMPLATE="#!/bin/sh\n\
\n\
export CFG_DIR=\"$CFG_DIR\"\nCUR_SHELL=\"\$(basename \"\$0\" | tr -d \"-\")\"\n\
IS_INTERACTIVE_SHELL=%s\n\
\n\
. \"$CFG_DIR/shells/dispatch\"\n"

if [ "$DEBUG" = "true" ]; then
  echo "Print template is: EOF\n$PRINT_TEMPLATE\nEOF\n"
fi

# Sets up machine-local endpoints that can be soft-linked to while still
# maintaining flexibility
touch "$LOCAL_DIR/shell_init"
printf "${PRINT_TEMPLATE}\n" 'false' > "$LOCAL_DIR/shell_init"
touch "$LOCAL_DIR/shell_interact_init"
printf "${PRINT_TEMPLATE}\n" 'true' > "$LOCAL_DIR/shell_interact_init"


# Function to check for existing configs, and move them if necessary
check_move() {
  file_path="$(realpath ~)/$1"


  if [ "$DEBUG" = "true" ]; then
    echo "check_move'ing file path $file_path"
  fi

  if test -f "$file_path"; then
    if [ "$DEBUG" = "true" ]; then
      echo "Detected existing file, moving to ${MOVE_DIR}/$1"
    fi
    move_safe "$file_path" "${MOVE_DIR}/$1"
  elif test -d "$file_path"; then
    if [ "$DEBUG" = "true" ]; then
      echo "Detected existing directory, moving to ${MOVE_DIR}/$1"
    fi
    move_safe "$file_path" "${MOVE_DIR}/$1"
  fi

  if [ "$DEBUG" = "true" ]; then
    echo "Creating softink to $(echo "${CFG_DIR}/$2"| tr -s "/")"
  fi

  ln -s "$(echo "${CFG_DIR}/$2" | tr -s "/")" "$file_path"

  if [ "$DEBUG" = "true" ]; then
    echo
  fi
}

# Create all the soft links
check_move .vimrc "/programs/neovim/init.vim"
check_move .vim "/programs/neovim"
check_move .bashrc "/local/shell_interact_init"
check_move .bash_profile "/local/shell_interact_init"
check_move .zshrc "/local/shell_interact_init"
check_move .gitconfig "/programs/gitconfig"
check_move .gitignore_global "/programs/gitignore_global"

